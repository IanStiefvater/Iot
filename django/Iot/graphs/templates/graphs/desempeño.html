{% load static %}

<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Gráficos de Desempeño</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">


   <style>
      .chart-div {
         height: 400px;
      }
      li {
        list-style-type: none;
      }
      ul {
        margin: 0px;
        padding: 0px;
        width: 100%;
      }
      li {
        display:flex;
        align-items:center;
      }
      li a:hover {
        background-color: #0f3247;
      }
      #hola:hover {
        background-color: #0f3247;
      }
   </style>

</head>
<body style="background-color: #9cd6f1"> 
    <header style="width: 100%; height: 100px; background-color: #425e6f; flex-direction: column !important" >
        <ul class="d-flex" style="height:100%">
          <li class="col-6">
            <h1 class="ms-5" style="color:white; text-align:center">Panel</h1>
          </li>
          <li class="col-2" style="cursor:pointer; border-left: 1px solid white">
            <a href="graphs" target="blank" class="col-12 button d-flex justify-content-center align-items-center" style="text-decoration:none; color: white; height:100%; font-size: 25px">Producción</a>
          </li>
          <li id="hola" class="col-2 d-flex justify-content-center align-items-center" style="cursor:pointer; border-left: 1px solid white; font-size:25px; color:white; text-align:center" data-bs-toggle="modal" data-bs-target="#dateModal">Seguimiento
          </li>
          <li class="col-2 d-flex align-items-center" style="cursor:pointer; border-left: 1px solid white">
            <a href="../linemanagement/select" class="col-12 button d-flex justify-content-center align-items-center" style="text-decoration:none; color: white; height:100%; font-size: 25px">Salir<span class="material-symbols-outlined" style="margin-left: 0.75rem">logout</span></a>
          </li>
        </ul>
      </header>
       <!-- Modal -->
        <div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="dateModalLabel">Elegir Fecha</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="date" id="dateInput" class="form-control">
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="saveDate">Guardar</button>
              </div>
            </div>
          </div>
        </div>
    <div class="" style="width:100%">
    {% for line in total_time_for_line_statuses %}
        <div class="col-12" style="padding-top:50px;padding-bottom:50px; border-bottom: 1px solid #ffffff">
            <div class="d-flex align-items-center justify-content-center" style="flex-direction:column">
                <div class="col-4 text-center mx-auto card mb-2" style="background-color: #0d3f70;border-radius:10px; box-shadow: 0 0 4px 0 rgba(0,0,0,.14), 0 3px 4px 0 rgba(0,0,0,.12), 0 1px 5px 0 rgba(0,0,0,.2);"><h2 style="margin-top:0.5rem; color:white">Línea {{ line.lineId }}</h2></div>
            </div>
            <div id="line_{{ line.line_name }}" class="line-div d-flex mt-5" style="justify-content:space-around !important">
                <div id="chart1_{{ line.lineId }}" class="chart-div " style="border-radius:15px; width: 45%; overflow: hidden; box-shadow: 0 0 4px 0 rgba(0,0,0,.14), 0 3px 4px 0 rgba(0,0,0,.12), 0 1px 5px 0 rgba(0,0,0,.2);"></div>
                <div id="chart2_{{ line.lineId }}" class="chart-div " style="border-radius:15px; width: 45%; overflow: hidden; box-shadow: 0 0 4px 0 rgba(0,0,0,.14), 0 3px 4px 0 rgba(0,0,0,.12), 0 1px 5px 0 rgba(0,0,0,.2);">
                </div>
            </div>
        </div>
    {% endfor %}
    </div>
    <div class="my-5 col-12">
        <div class="d-flex align-items-center justify-content-center" style="flex-direction:column">
            <div class="col-4 text-center mx-auto card mb-2" style="background-color: #0d3f70;border-radius:10px; box-shadow: 0 0 4px 0 rgba(0,0,0,.14), 0 3px 4px 0 rgba(0,0,0,.12), 0 1px 5px 0 rgba(0,0,0,.2);"><h2 style="margin-top:0.5rem; color:white">Desglose de todas las líneas</h2></div>
        </div>
        <div id="chart3" class="chart-div col-8 mx-auto mt-5" style="border-radius:15px; overflow: hidden; box-shadow: 0 0 4px 0 rgba(0,0,0,.14), 0 3px 4px 0 rgba(0,0,0,.12), 0 1px 5px 0 rgba(0,0,0,.2);">
        </div>
    </div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {packages: ['corechart', 'bar']});
        google.charts.setOnLoadCallback(drawCharts);
    
        function drawCharts() {
            var total_time_for_lines_maintenance = ({{ total_time_for_lines | safe }});
            var total_time_for_devices_maintenance = ({{ total_time_for_devices | safe }});
            var total_time_for_points = ({{ total_time_for_points | safe }});
            var total_time_for_devices = ({{ total_time_for_device_statuses | safe }});
            var total_time_for_lines = ({{ total_time_for_line_statuses | safe }});
    
    
            for (const line of total_time_for_lines) {
                drawChart1(line.lineId, total_time_for_devices, total_time_for_devices_maintenance);
                drawChart2(line.lineId, total_time_for_devices_maintenance, total_time_for_points);
            }        
            drawChart3(total_time_for_lines_maintenance, total_time_for_lines);
        }
    
        function drawChart1(lineId, devices, maintenanceDevices) {
            var chartData = new google.visualization.DataTable();
            chartData.addColumn('string', 'Dispositivo');
            chartData.addColumn('number', 'Tiempo de Inactividad');
            chartData.addColumn('number', 'Tiempo Total sin Mantenimiento');
        
            var filteredDevices = devices.filter(device => device.lineId === lineId);
            console.log (filteredDevices);
        
            for (var device of filteredDevices) {
                var deviceName = device.device_name;
                var deviceTotalTime = device.total_time;
        
                var deviceMaintenance = maintenanceDevices.find(deviceMaint => deviceMaint.device_name === deviceName && deviceMaint.lineId === lineId);
        
                var deviceMaintenanceTime = deviceMaintenance ? deviceMaintenance.total_time : 0;
                
                chartData.addRow([deviceName, deviceMaintenanceTime, deviceTotalTime - deviceMaintenanceTime]);
            }
        
            var options = {
                title: 'Tiempo Total de Dispositivo e Inactividad',
                chartArea: {width: '60%'},
                hAxis: {
                    title: 'Dispostivos',
                    minValue: 0
                },
                vAxis: {
                    title: 'Tiempo Total'
                },
                colors: ['#D97C05', '#FFBE6C'],
                isStacked: true
            };
        
            var chart = new google.visualization.ColumnChart(document.getElementById(`chart1_${lineId}`));
            chart.draw(chartData, options);
        }
        
        
    
    
        function drawChart2(lineId, maintenanceDevices, total_time_for_points) {
            var chartData = new google.visualization.DataTable();
            chartData.addColumn('string', 'Dispositivo');
            chartData.addColumn('number', 'Set Up');
            chartData.addColumn('number', 'Mantenimiento');
            chartData.addColumn('number', 'Imprevisto');
        
            var filteredMaintenanceDevices = maintenanceDevices.filter(device => device.lineId === lineId);
            console.log (filteredMaintenanceDevices);
        
            for (var device of filteredMaintenanceDevices) {
                var deviceId = device.device_id;
                var setUpTime = 0;
                var maintenanceTime = 0;
                var unforeseenTime = 0;
        
                for (var point of total_time_for_points) {
                    if (point.deviceId === deviceId && point.lineId === lineId) {
                        if (point.point_name === 'Set Up') {
                            setUpTime += parseInt(point.total_time);
                        } else if (point.point_name === 'Mantenimiento') {
                            maintenanceTime += parseInt(point.total_time);
                        } else if (point.point_name === 'Imprevisto') {
                            unforeseenTime += parseInt(point.total_time);
                        }
                    }
                }
        
                chartData.addRow([device.device_name, setUpTime, maintenanceTime, unforeseenTime]);
            }
        
            var options = {
                title: 'Desglose de Tiempos de Inactividad',
                chartArea: {width: '60%'},
                hAxis: {
                    title: 'Dispositivos',
                    minValue: 0
                },
                vAxis: {
                    title: 'Tiempo Total'
                },
                colors: ['#3B83A1', '#63A69F', '#734C37'],
                isStacked: true
            };
        
            var chart = new google.visualization.ColumnChart(document.getElementById(`chart2_${lineId}`));
            chart.draw(chartData, options);
        }
        
    
    
        function drawChart3(maintenanceLines, lines) {
            var chartData = new google.visualization.DataTable();
            chartData.addColumn('string', 'Línea');
            chartData.addColumn('number', 'Tiempo de Mantenimiento');        
            chartData.addColumn('number', 'Tiempo sin Mantenimiento');
            
    
            for (var line of lines) {
                var lineName = line.line_name;
                var lineTotalTime = line.total_time;
                var lineMaintenanceTime = 0;
    
                for (var lineMaint of maintenanceLines) {
                    if (lineMaint.line_name === lineName) {
                        lineMaintenanceTime = lineMaint.total_time;
                        break;
                    }
                }
    
                chartData.addRow([lineName, lineMaintenanceTime, lineTotalTime - lineMaintenanceTime]);
            }
    
            //console.log(`Datos para chart3:`, chartData.toJSON());
    
            var options = {
                title: 'Tiempo Total de Línea y Mantenimiento',
                chartArea: {width: '70%'},
                hAxis: {
                    title: 'Tiempo Total',
                    minValue: 0
                },
                vAxis: {
                    title: 'Línea'
                },
                colors: ['#8E93A1','#5863F8'],
                isStacked: true
            };
    
            var chart = new google.visualization.ColumnChart(document.getElementById('chart3'));
            chart.draw(chartData, options);
        }

    </script>
</body>
</html>



